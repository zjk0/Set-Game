# 神奇形色牌（Set）

## 简介

四种属性，每种属性三个取值：个数（1、2、3），颜色（红、绿、紫），形状（菱形、椭圆形、波浪形），纹路（实心、条纹、空心）。

三张牌可以成为一组Set需要符合以下所有条件：

- 三张牌的数字相同，或者都不相同。
- 三张牌的颜色相同，或者都不相同。
- 三张牌的形状相同，或者都不相同。
- 三张牌的纹路相同，或者都不相同。

现在需要通过数字图像处理技术，从一系列牌中，找出所有的Set。

## 思考

首先，需要把图像中的牌找出来，然后考虑如何识别牌的四种属性，然后再判断有没有set

除了颜色这个属性，其他三个属性在灰度图像中也能识别出来，所以对于一张图像，可以有两个副本，一个副本是RGB图像，一个副本是灰度图像，RGB图像用于识别颜色属性，灰度图像用于识别形状、个数、纹路这三个属性。

### 感觉需要注意的地方

第一，图形的纹路，我认为会对边缘检测有影响，尤其是条纹填充，可能会影响到除了颜色以外的属性的判断，所以需要先检测填充方式，在检测别的属性。检测出填充方式之后，由于填充方式不会影响后续的操作，所以可以对条纹填充的图形，先进行一次闭运算，将条纹消去，再进行后续操作。其实对于任何类似于“白中带黑点”的情况，都可以考虑使用闭运算来把“黑点”消去。

第二，原始图像较大，需要先进行缩小，再进行相应的操作。但是缩小之后，条纹这种填充方式的分辨率将会下降，可能会影响检测。

### 牌的寻找

对图像进行二值化，此时背景为黑色，纸牌非图形部分为白色，纸牌图形部分为黑色，然后检测连通域，得到图像中所有set纸牌的位置，其中采用连通域边界拟合的方式来获取连通域中心的大致位置和大致大小

### 颜色识别

在一张牌中，先进行canny边缘检测，找出边缘坐标，回到RGB图像，转换为HSV空间，对边缘的H值取平均，判断其平均的H值所在范围。

### 个数识别

在一张牌中，先进行基于阈值的图像分割，也可以说是图像二值化，纸牌上的图像为黑色，因为图像的边缘不是严格的一个像素，而是一条有宽度的边，因为条纹会影响判断，但是条纹比较细，所以我认为可以这样：因为知道了内部填充，所以可以先判断填充，如果不是条纹，则进行操作A，如果是条纹，因为基于阈值的图像分割将图像整为黑色，所以采取先膨胀后腐蚀，也就是闭运算，去除条纹，填充变为空心，再进行操作A，操作A指的是：找到中心，向下遍历，如果是实心的，判断像素值变化的次数，其他填充则判断像素值由小变大的次数，从而得到图形个数。

当个数为偶数，上述方法失效

### 纹路识别

在一张牌中，先进行canny边缘检测，然后将一张牌取出来，找到中心点，取中心点的一个邻域，计算方差，方差较大的，判断为条纹，方差较小的，判断为空心或者实心，计算平均值，如果平均值较大，判断为实心，如果平均值较小，判断为空心。

### 形状识别

在一张牌中，先进行基于边缘的图像分割，然后沿着图像的竖直中轴线，从上往下扫描，找到边缘点之后，开始遍历该边缘点所在的行的全部像素点，查找有多少个边缘点，通过这一行的边缘点的个数来判断形状。

### 注意

由于直接进行canny边缘检测有较多噪声，考虑先将图像二值化，再进行canny边缘检测。

### 最终思路

先检测数量，进行二值化之后，此时背景为黑色，纸牌非图形部分为白色，纸牌图形部分为黑色，然后使用膨胀核小于腐蚀核的开运算，将条纹填充的条纹给消除，便于进行数量检测，此时，图形的填充要么是实心，要么是空心。因为有了纸牌的大致中心坐标和大致的大小，所以从中心开始竖直向下遍历，获取数值从小变大的次数，当次数为3（空心）或6（实心），就有3个图形，当次数为4（实心），就有2个图形，当次数为1（空心），就有1个图形，当次数为2，此时根据第一次数值变化和第二次数值变化之间的距离来判断，距离较长（实心），就有2个图形，距离较短（空心），就有1个图形

然后检测纹路，当个数为1或3的时候，取以中心点为中心的一条直线，计算方差，当个数为2的时候，分别向上和向下取直线, 然后合并，然后计算方差。如果方差大于0, 图形内部像素有变化, 说明是条纹纹路，否则，计算均值，如果均值较小, 说明图形内部偏向于黑色, 说明是实心纹路；如果均值较大, 说明图形内部偏向于白色, 说明是空心纹路。